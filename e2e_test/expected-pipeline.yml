# Generated using halfpipe cli version 0.0.0-DEV
groups: []
resources:
- name: git
  type: git
  source:
    uri: https://github.com/robwhitby/halfpipe-example-nodejs
- name: slack
  type: slack-notification
  source:
    url: https://hooks.slack.com/services/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
- name: artifacts-engineering-enablement-e2e-test
  type: gcp-resource
  source:
    bucket: halfpipe-artifacts
    folder: engineering-enablement/e2e-test
    json_key: ((gcr.private_key))
- name: CF dev-api engineering-enablement dev
  type: cf-resource
  source:
    api: dev-api
    org: engineering-enablement
    password: very-secret
    space: dev
    username: michiel
- name: CF api-live pe staging
  type: cf-resource
  source:
    api: ((cloudfoundry.api-live))
    org: pe
    password: very-secret
    space: staging
    username: michiel
- name: Docker Registry
  type: docker-image
  source:
    password: verysecret
    repository: springerplatformengineering/halfpipe-fly
    username: rob
resource_types:
- name: slack-notification
  type: docker-image
  source:
    repository: cfcommunity/slack-notification-resource
    tag: latest
- name: gcp-resource
  type: docker-image
  source:
    repository: platformengineering/gcp-resource
    tag: 0.14.0
- name: cf-resource
  type: docker-image
  source:
    repository: platformengineering/cf-resource
    tag: stable
jobs:
- name: Test
  serial: true
  plan:
  - get: git
    trigger: true
  - task: run
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: node
          tag: 9.5.0-alpine
      run:
        path: /bin/sh
        args:
        - -ec
        - |
          export GIT_REVISION=`cat .git/ref`
          ./test.sh

          if [ -d target/distribution ]
          then
            mkdir -p ../artifacts/target/distribution
            cp -r target/distribution/. ../artifacts/target/distribution/
          elif [ -f target/distribution ]
          then
            artifactDir=$(dirname target/distribution)
            mkdir -p ../artifacts/$artifactDir
            cp target/distribution ../artifacts/$artifactDir
          else
            echo "ERROR: Artifact 'target/distribution' not found. Try fly hijack to check the filesystem."
            exit 1
          fi


          if [ -d README.md ]
          then
            mkdir -p ../artifacts/README.md
            cp -r README.md/. ../artifacts/README.md/
          elif [ -f README.md ]
          then
            artifactDir=$(dirname README.md)
            mkdir -p ../artifacts/$artifactDir
            cp README.md ../artifacts/$artifactDir
          else
            echo "ERROR: Artifact 'README.md' not found. Try fly hijack to check the filesystem."
            exit 1
          fi
        dir: git
      inputs:
      - name: git
        path: ""
      outputs:
      - name: artifacts
        path: ""
  - put: artifacts-engineering-enablement-e2e-test
    params:
      folder: artifacts
      version_file: git/.git/ref
  on_failure:
    put: slack
    params:
      channel: '#ee-re'
      icon_url: https://concourse.halfpipe.io/public/images/favicon-failed.png
      text: The pipeline `$BUILD_PIPELINE_NAME` failed at `$BUILD_JOB_NAME`. <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME>
      username: Halfpipe
- name: deploy-cf
  serial: true
  plan:
  - get: git
    passed:
    - Test
    trigger: true
  - get: artifacts-engineering-enablement-e2e-test
    params:
      folder: artifacts
      version_file: git/.git/ref
  - put: CF dev-api engineering-enablement dev
    params:
      appPath: artifacts-engineering-enablement-e2e-test/target/distribution/artifact.zip
      command: halfpipe-push
      manifestPath: git/manifest.yml
      testDomain: ""
  - put: CF dev-api engineering-enablement dev
    params:
      appPath: artifacts-engineering-enablement-e2e-test/target/distribution/artifact.zip
      command: halfpipe-promote
      manifestPath: git/manifest.yml
      testDomain: ""
  - put: CF dev-api engineering-enablement dev
    params:
      appPath: artifacts-engineering-enablement-e2e-test/target/distribution/artifact.zip
      command: halfpipe-delete
      manifestPath: git/manifest.yml
      testDomain: ""
  on_failure:
    put: slack
    params:
      channel: '#ee-re'
      icon_url: https://concourse.halfpipe.io/public/images/favicon-failed.png
      text: The pipeline `$BUILD_PIPELINE_NAME` failed at `$BUILD_JOB_NAME`. <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME>
      username: Halfpipe
- name: deploy to staging
  serial: true
  plan:
  - get: git
    passed:
    - deploy-cf
    trigger: true
  - put: CF api-live pe staging
    params:
      appPath: git
      command: halfpipe-push
      manifestPath: git/manifest.yml
      testDomain: live.cf.private.springer.com
      vars:
        A: "0.1"
        B: "false"
  - task: run
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: node
          tag: 9.5.0-alpine
      params:
        A: blah
        TEST_ROUTE: halfpipe-example-kotlin-dev-CANDIDATE.live.cf.private.springer.com
      run:
        path: /bin/sh
        args:
        - -ec
        - |-
          export GIT_REVISION=`cat .git/ref`
          ./smoke-test.sh
        dir: git
      inputs:
      - name: git
        path: ""
  - put: CF api-live pe staging
    params:
      appPath: git
      command: halfpipe-promote
      manifestPath: git/manifest.yml
      testDomain: live.cf.private.springer.com
      vars:
        A: "0.1"
        B: "false"
  - put: CF api-live pe staging
    params:
      appPath: git
      command: halfpipe-delete
      manifestPath: git/manifest.yml
      testDomain: live.cf.private.springer.com
      vars:
        A: "0.1"
        B: "false"
  on_failure:
    put: slack
    params:
      channel: '#ee-re'
      icon_url: https://concourse.halfpipe.io/public/images/favicon-failed.png
      text: The pipeline `$BUILD_PIPELINE_NAME` failed at `$BUILD_JOB_NAME`. <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME>
      username: Halfpipe
- name: push to docker registry
  serial: true
  plan:
  - get: git
    passed:
    - deploy to staging
    trigger: true
  - put: Docker Registry
    params:
      build: git
      build_args:
        A: a
        B: b
  on_failure:
    put: slack
    params:
      channel: '#ee-re'
      icon_url: https://concourse.halfpipe.io/public/images/favicon-failed.png
      text: The pipeline `$BUILD_PIPELINE_NAME` failed at `$BUILD_JOB_NAME`. <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME>
      username: Halfpipe
- name: run notify.sh
  serial: true
  plan:
  - get: git
    passed:
    - push to docker registry
    trigger: true
  - task: run
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          password: blah
          repository: busy
          tag: latest
          username: michiel
      params:
        A: a
        B: b
      run:
        path: /bin/sh
        args:
        - -ec
        - |-
          export GIT_REVISION=`cat .git/ref`
          ./notify.sh
        dir: git
      inputs:
      - name: git
        path: ""
  on_failure:
    put: slack
    params:
      channel: '#ee-re'
      icon_url: https://concourse.halfpipe.io/public/images/favicon-failed.png
      text: The pipeline `$BUILD_PIPELINE_NAME` failed at `$BUILD_JOB_NAME`. <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME>
      username: Halfpipe
- name: docker-compose
  serial: true
  plan:
  - get: git
    passed:
    - run notify.sh
    trigger: true
  - task: run
    privileged: true
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: amidos/dcind
          tag: latest
      params:
        GCR_PRIVATE_KEY: ((gcr.private_key))
      run:
        path: /bin/sh
        args:
        - -ec
        - |
          export GIT_REVISION=`cat .git/ref`
          \source /docker-lib.sh
          start_docker
          docker login -u _json_key -p "$GCR_PRIVATE_KEY" https://eu.gcr.io

          docker-compose run -e GIT_REVISION=${GIT_REVISION} app
          rc=$?

          docker-compose down

          exit $rc
        dir: git
      inputs:
      - name: git
        path: ""
  on_failure:
    put: slack
    params:
      channel: '#ee-re'
      icon_url: https://concourse.halfpipe.io/public/images/favicon-failed.png
      text: The pipeline `$BUILD_PIPELINE_NAME` failed at `$BUILD_JOB_NAME`. <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME>
      username: Halfpipe


groups: []
resources:
- name: release
  type: github-release
  source:
    access_token: ((api-keys.halfpipe-cli))
    owner: springernature
    repository: halfpipe
- name: halfpipe
  type: git
  source:
    branch: master
    private_key: ((github.private_key))
    uri: git@github.com:springernature/halfpipe.git
- name: version
  type: semver
  source:
    branch: version
    driver: git
    file: version
    private_key: ((github.private_key))
    uri: git@github.com:springernature/halfpipe.git
resource_types: []
jobs:
- name: Test
  serial: true
  plan:
  - get: halfpipe
    trigger: true
  - task: Test
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: golang
          tag: 1.10-alpine3.7
      run:
        path: /bin/sh
        args:
        - -ec
        - |
          ls -al
          export GOPATH=$PWD
          cd src/github.com/springernature/halfpipe
          go test ./...
      inputs:
      - name: halfpipe
        path: /src/github.com/springernature/halfpipe
- name: Bump Major
  plan:
  - put: version
    params:
      bump: major
- name: Bump Minor
  plan:
  - put: version
    params:
      bump: minor
- name: Bump Patch
  plan:
  - put: version
    params:
      bump: patch
- name: Create GitHub release
  disable_manual_trigger: true
  plan:
  - aggregate:
    - get: halfpipe
      passed:
      - End2End Test
    - get: version
      trigger: true
  - task: Build
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: golang
          tag: 1.10-alpine3.7
      run:
        path: /bin/sh
        args:
        - -ec
        - |
          export ROOT="$PWD"
          export GOPATH="$PWD"
          export VERSION="$(cat version/version)"
          export DATE_TIME="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          export GIT_COMMIT="$(cat src/github.com/springernature/halfpipe/.git/ref)"
          export CONF_PKG="github.com/springernature/halfpipe/config"
          export LDFLAGS="-X ${CONF_PKG}.Version=${VERSION}"
          export LDFLAGS="${LDFLAGS} -X ${CONF_PKG}.CompiledAt=${DATE_TIME}"
          export LDFLAGS="${LDFLAGS} -X ${CONF_PKG}.GitCommit=${GIT_COMMIT}"
          export LDFLAGS="${LDFLAGS} -X ${CONF_PKG}.VaultPrefix=springernature"
          export LDFLAGS="${LDFLAGS} -X ${CONF_PKG}.DocHost=docs.halfpipe.io"
          export LDFLAGS="${LDFLAGS} -X ${CONF_PKG}.SlackWebhook=https://hooks.slack.com/services/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"
          echo "LDFLAGS=${LDFLAGS}"

          # Build binaries
          cd src/github.com/springernature/halfpipe
          CGO_ENABLED=0 GOARCH=amd64 GOOS=darwin go build -o halfpipe_darwin -ldflags "${LDFLAGS}" cmd/halfpipe.go
          CGO_ENABLED=0 GOARCH=amd64 GOOS=linux go build -o halfpipe_linux -ldflags "${LDFLAGS}" cmd/halfpipe.go
          cp halfpipe_darwin halfpipe_linux $ROOT/binaries
      inputs:
      - name: halfpipe
        path: src/github.com/springernature/halfpipe
      - name: version
        path: ""
      outputs:
      - name: binaries
        path: ""
  - put: halfpipe
    params:
      repository: halfpipe
      tag: version/version
  - put: release
    params:
      globs:
      - binaries/halfpipe_*
      name: halfpipe/name
      tag: version/version
- name: End2End Test
  serial: true
  plan:
  - get: halfpipe
    passed:
    - Test
    trigger: true
  - task: Test
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: eu.gcr.io/halfpipe-io/halfpipe-fly
          username: _json_key
          password: ((gcr.private_key))
      run:
        path: /bin/sh
        args:
        - -ec
        - |
          export ROOT="$PWD"
          export GOPATH="$PWD"
          export DATE_TIME="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          export GIT_COMMIT="$(cat src/github.com/springernature/halfpipe/.git/ref)"
          export CONF_PKG="github.com/springernature/halfpipe/config"
          export LDFLAGS="-X ${CONF_PKG}.Version=0.0.0-DEV"
          export LDFLAGS="${LDFLAGS} -X ${CONF_PKG}.CompiledAt=${DATE_TIME}"
          export LDFLAGS="${LDFLAGS} -X ${CONF_PKG}.GitCommit=${GIT_COMMIT}"
          export LDFLAGS="${LDFLAGS} -X ${CONF_PKG}.VaultPrefix=springernature"
          export LDFLAGS="${LDFLAGS} -X ${CONF_PKG}.DocHost=docs.halfpipe.io"
          export LDFLAGS="${LDFLAGS} -X ${CONF_PKG}.SlackWebhook=https://hooks.slack.com/services/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"
          echo "LDFLAGS=${LDFLAGS}"

          # Build binaries
          cd src/github.com/springernature/halfpipe
          CGO_ENABLED=0 GOARCH=amd64 GOOS=linux go build -o halfpipe_linux -ldflags "${LDFLAGS}" cmd/halfpipe.go

          cd e2e_test
          ./test.sh ../halfpipe_linux
      inputs:
      - name: halfpipe
        path: /src/github.com/springernature/halfpipe
